<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menú (Cliente) - Al Sahara</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="core/styles.css">
    <style>
      .product-image img { width: 100%; height: auto; border-radius: .5rem; object-fit: cover; }
      .btn-rounded { border-radius: 50px; }
      .pagination-info { display:flex; gap:.75rem; justify-content:center; align-items:center; margin-top:1rem; }
    </style>
    <script>
      // Fallback for older browsers lacking closest on Element
      if (!Element.prototype.closest) {
        Element.prototype.closest = function(s) {
          var el = this;
          do { if (el.matches(s)) return el; el = el.parentElement || el.parentNode; } while (el !== null && el.nodeType === 1);
          return null;
        };
      }
    </script>
    <script>
      // nav minimal population (optional)
      document.addEventListener('DOMContentLoaded', () => {
        const ul = document.getElementById('navMenu');
        if (!ul) return;
        ul.innerHTML = `
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link active" href="catalog-client.html">Menú</a></li>
          <li class="nav-item"><a class="nav-link" href="cart.html">Carrito</a></li>
          <li class="nav-item"><a class="nav-link" href="login.html">Ingresar</a></li>
        `;
      });
    </script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-utensils"></i> Al Sahara
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto" id="navMenu"></ul>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Catalog Content -->
    <div class="container mt-4 mb-5">
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-book-open"></i> Nuestro Menú</h2>
                <p class="text-muted mb-0">Vista para clientes: solo productos disponibles y opción de compra.</p>
            </div>
        </div>

        <!-- Featured Products Section -->
        <div id="featuredSection" style="display:none;">
            <h4 class="mb-3"><i class="fas fa-star text-warning"></i> Productos Destacados</h4>
            <div id="featuredProducts" class="row mb-4"></div>
            <hr class="mb-4">
        </div>

        <!-- Search and Filters -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <input type="text" class="form-control" id="searchInput" placeholder="¿Buscar productos...?" />
            </div>
            <div class="col-md-6 mb-3">
                <div class="btn-group w-100" role="group">
                    <button class="btn btn-outline-secondary filter-btn active" data-category="all">Todos</button>
                    <button class="btn btn-outline-secondary filter-btn" data-category="Shawarma">Shawarmas</button>
                    <button class="btn btn-outline-secondary filter-btn" data-category="Falafel">Falafel</button>
                    <button class="btn btn-outline-secondary filter-btn" data-category="Kebab">Kebab</button>
                    <button class="btn btn-outline-secondary filter-btn" data-category="Salsa">Salsa</button>
                    <button class="btn btn-outline-secondary filter-btn" data-category="Bebida">Bebidas</button>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div id="productsGrid" class="row"></div>

        <!-- Pagination -->
        <div class="pagination-info">
            <button class="btn btn-outline-primary" id="prevPage" disabled>
                <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <span id="pageInfo">Página 1 de 1</span>
            <button class="btn btn-outline-primary" id="nextPage" disabled>
                Siguiente <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProductName"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="modalProductImage" class="product-image mb-3"></div>
                        </div>
                        <div class="col-md-6">
                            <h4 id="modalProductPrice" class="text-primary mb-3"></h4>
                            <h6>Ingredientes:</h6>
                            <ul id="modalProductIngredients"></ul>
                            <div id="modalProductStock" class="alert"></div>
                            <div class="d-grid">
                                <button id="modalAddToCart" class="btn btn-primary btn-lg btn-rounded">
                                    <i class="fas fa-cart-plus"></i> Añadir al Carrito
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
(() => {
  const API = "http://localhost:3001";
  const qs = (s, p=document) => p.querySelector(s);
  const qsa = (s, p=document) => [...p.querySelectorAll(s)];

  // refs UI
  const grid = qs("#productsGrid");
  const featuredSection = qs("#featuredSection");
  const featuredWrap = qs("#featuredProducts");
  const searchInput = qs("#searchInput");
  const filterBtns = qsa(".filter-btn");
  const pageInfo = qs("#pageInfo");
  const prevBtn = qs("#prevPage");
  const nextBtn = qs("#nextPage");

  // modal
  const modalEl = qs("#productModal");
  const modal = new bootstrap.Modal(modalEl);
  const modalName = qs("#modalProductName");
  const modalPrice = qs("#modalProductPrice");
  const modalImage = qs("#modalProductImage");
  const modalIngr = qs("#modalProductIngredients");
  const modalStock = qs("#modalProductStock");
  const modalAdd = qs("#modalAddToCart");

  let sessionUser = null;
  const state = { q: "", category: "all", page: 1, pages: 1 };

  async function whoami(){
    try {
      const res = await fetch(API + "/api/auth/me", { credentials: "include" });
      const { user } = res.ok ? await res.json() : { user: null };
      sessionUser = user; // {id, name, email, role} | null
    } catch {
      sessionUser = null;
    }
  }

  function renderCard(p){
    const tags = (p.tags ?? []).map(t => `<span class="badge text-bg-secondary me-1">${t}</span>`).join("");
    const badge = p.featured ? `<span class="badge text-bg-warning ms-2"><i class="fa fa-star"></i> Destacado</span>` : "";
    const stock = p.available ? `<span class="badge text-bg-success">Disponible</span>` : `<span class="badge text-bg-danger">Agotado</span>`;

    return `
      <div class="col-md-4 col-lg-3 mb-4">
        <div class="card h-100 shadow-sm">
          <img src="${p.imagen}" class="card-img-top" alt="${p.nombre}" style="height:180px; object-fit:cover">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title mb-1">${p.nombre} ${badge}</h5>
            <div class="mb-2 small">${tags}</div>
            <div class="mb-2">${stock}</div>
            <p class="card-text text-primary fw-bold mb-3">$${p.price}</p>
            <div class="mt-auto d-grid gap-2">
              <button class="btn btn-outline-primary" data-action="ver" data-id="${p.id}">
                <i class="fa fa-eye"></i> Ver detalle
              </button>
              <button class="btn btn-primary" data-action="add" data-id="${p.id}" ${p.available ? "" : "disabled"}>
                <i class="fa fa-cart-plus"></i> Añadir al carrito
              </button>
            </div>
          </div>
        </div>
      </div>`;
  }

  async function fetchProducts(){
    const params = new URLSearchParams();
    if (state.q) params.set("q", state.q);
    if (state.category && state.category !== "all") params.set("category", state.category);
    params.set("onlyAvailable", "1");
    params.set("page", state.page);
    params.set("limit", 12);
    const url = API + "/api/productos?" + params.toString();
    const res = await fetch(url, { credentials: "include" });
    if (!res.ok) throw new Error("No se pudo cargar productos");
    return res.json(); // { items, total, page, pages }
  }

  async function load(){
    await whoami();
    const { items, page, pages } = await fetchProducts();

    const featured = items.filter(i => i.featured && i.available);
    if (featured.length) {
      featuredSection.style.display = "";
      featuredWrap.innerHTML = featured.map(renderCard).join("");
    } else {
      featuredSection.style.display = "none";
      featuredWrap.innerHTML = "";
    }

    grid.innerHTML = items.map(renderCard).join("");

    state.pages = pages;
    pageInfo.textContent = `Página ${page} de ${pages}`;
    prevBtn.disabled = page <= 1;
    nextBtn.disabled = page >= pages;
  }

  // Handlers UI
  searchInput?.addEventListener("input", (e) => {
    state.q = e.target.value.trim();
    state.page = 1;
    load().catch(console.error);
  });

  filterBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      filterBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      state.category = btn.dataset.category || "all";
      state.page = 1;
      load().catch(console.error);
    });
  });

  prevBtn.addEventListener("click", () => { if (state.page>1){ state.page--; load().catch(console.error);} });
  nextBtn.addEventListener("click", () => { if (state.page<state.pages){ state.page++; load().catch(console.error);} });

  // Delegación de eventos
  document.addEventListener("click", async (ev) => {
    const btn = ev.target.closest("button[data-action]");
    if (!btn) return;
    const id = Number(btn.dataset.id);
    const action = btn.dataset.action;

    if (action === "ver") {
      const res = await fetch(`${API}/api/productos/${id}`, { credentials: "include" });
      const p = await res.json();
      modalName.textContent = p.nombre;
      modalPrice.textContent = `$${p.price}`;
      modalImage.innerHTML = `<img src="${p.imagen}" class="img-fluid rounded">`;
      modalIngr.innerHTML = (p.ingredients || []).map(i => `<li>${i}</li>`).join("");
      modalStock.className = "alert " + (p.available ? "alert-success" : "alert-danger");
      modalStock.textContent = p.available ? "Disponible" : "Agotado";
      modalAdd.disabled = !p.available;
      modalAdd.onclick = () => addToCart(id).catch(console.error);
      modal.show();
    }

    if (action === "add") {
      await addToCart(id);
    }
  });

  async function addToCart(productId){
    if (!sessionUser || sessionUser.role !== 'cliente') {
      alert('Inicia sesión como cliente para comprar.');
      window.location.href = 'login.html?redirect=catalog-client.html';
      return;
    }
    const res = await fetch(`${API}/api/carrito/items`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      credentials: "include",
      body: JSON.stringify({ producto_id: productId, cantidad: 1 })
    });
    if (!res.ok) { alert("No se pudo añadir al carrito"); return; }
    alert("Producto añadido al carrito");
  }

  document.addEventListener("DOMContentLoaded", () => load().catch(console.error));
})();
    </script>

  </body>
</html>
