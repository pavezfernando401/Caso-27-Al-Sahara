<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menú (Staff) - Al Sahara</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="core/styles.css">
    <style>
      .product-image img { width: 100%; height: auto; border-radius: .5rem; object-fit: cover; }
      .btn-rounded { border-radius: 50px; }
      .pagination-info { display:flex; gap:.75rem; justify-content:center; align-items:center; margin-top:1rem; }
    </style>
    <script>
      // nav minimal population (optional)
      document.addEventListener('DOMContentLoaded', () => {
        const ul = document.getElementById('navMenu');
        if (!ul) return;
        ul.innerHTML = `
          <li class=\"nav-item\"><a class=\"nav-link\" href=\"index.html\">Inicio</a></li>
          <li class=\"nav-item\"><a class=\"nav-link\" href=\"catalog-client.html\">Menú Cliente</a></li>
          <li class=\"nav-item\"><a class=\"nav-link active\" href=\"catalog-staff.html\">Menú Staff</a></li>
          <li class=\"nav-item\"><a class=\"nav-link\" href=\"orders.html\">Pedidos</a></li>
        `;
      });
    </script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-utensils"></i> Al Sahara
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto" id="navMenu"></ul>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Catalog Content -->
    <div class="container mt-4 mb-5">
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-book-open"></i> Gestión de Menú</h2>
                <p class="text-muted mb-0">Vista para administradores y cajeros: ver todo y marcar disponible/agotado.</p>
            </div>
        </div>
        
        <!-- Search and Filters -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <input type="text" class="form-control" id="searchInput" placeholder="Buscar productos...">
            </div>
            <div class="col-md-6 mb-3">
                <div class="btn-group w-100" role="group">
                    <button class="btn btn-outline-secondary filter-btn active" data-category="all">Todos</button>
                    <button class="btn btn-outline-secondary filter-btn" data-category="Shawarma">Shawarmas</button>
                    <button class="btn btn-outline-secondary filter-btn" data-category="Falafel">Falafel</button>
                    <button class="btn btn-outline-secondary filter-btn" data-category="Kebab">Kebab</button>
                    <button class="btn btn-outline-secondary filter-btn" data-category="Salsa">Salsa</button>
                    <button class="btn btn-outline-secondary filter-btn" data-category="Bebida">Bebidas</button>
                </div>
            </div>
        </div>
        
        <!-- Products Grid -->
        <div id="productsGrid" class="row"></div>
        
        <!-- Pagination -->
        <div class="pagination-info">
            <button class="btn btn-outline-primary" id="prevPage" disabled>
                <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <span id="pageInfo">Página 1 de 1</span>
            <button class="btn btn-outline-primary" id="nextPage" disabled>
                Siguiente <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Product Detail Modal (sin botón de carrito) -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProductName"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="modalProductImage" class="product-image mb-3"></div>
                        </div>
                        <div class="col-md-6">
                            <h4 id="modalProductPrice" class="text-primary mb-3"></h4>
                            <h6>Ingredientes:</h6>
                            <ul id="modalProductIngredients"></ul>
                            <div id="modalProductStock" class="alert"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
(() => {
  const API = "http://localhost:3001";
  const qs = (s, p=document) => p.querySelector(s);
  const qsa = (s, p=document) => [...p.querySelectorAll(s)];

  // refs UI
  const grid = qs("#productsGrid");
  const searchInput = qs("#searchInput");
  const filterBtns = qsa(".filter-btn");
  const pageInfo = qs("#pageInfo");
  const prevBtn = qs("#prevPage");
  const nextBtn = qs("#nextPage");

  // modal
  const modalEl = qs("#productModal");
  const modal = new bootstrap.Modal(modalEl);
  const modalName = qs("#modalProductName");
  const modalPrice = qs("#modalProductPrice");
  const modalImage = qs("#modalProductImage");
  const modalIngr = qs("#modalProductIngredients");
  const modalStock = qs("#modalProductStock");

  let sessionUser = null;
  const state = { q: "", category: "all", page: 1, pages: 1 };

  async function whoamiAndGuard(){
    const res = await fetch(API + "/api/auth/me", { credentials: "include" });
    if (!res.ok) {
      window.location.href = 'login.html?redirect=catalog-staff.html';
      return Promise.reject();
    }
    const { user } = await res.json();
    sessionUser = user;
    const allowed = user && (user.role === 'admin' || user.role === 'cajero');
    if (!allowed) {
      window.location.href = 'login.html?redirect=catalog-staff.html';
      return Promise.reject();
    }
  }

  function renderCard(p){
    const tags = (p.tags ?? []).map(t => `<span class="badge text-bg-secondary me-1">${t}</span>`).join("");
    const badge = p.featured ? `<span class="badge text-bg-warning ms-2"><i class="fa fa-star"></i> Destacado</span>` : "";
    const stock = p.available ? `<span class="badge text-bg-success">Disponible</span>` : `<span class="badge text-bg-danger">Agotado</span>`;
    const canToggle = sessionUser && (sessionUser.role === "admin" || sessionUser.role === "cajero");

    return `
      <div class="col-md-4 col-lg-3 mb-4">
        <div class="card h-100 shadow-sm">
          <img src="${p.imagen}" class="card-img-top" alt="${p.nombre}" style="height:180px; object-fit:cover">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title mb-1">${p.nombre} ${badge}</h5>
            <div class="mb-2 small">${tags}</div>
            <div class="mb-2">${stock}</div>
            <p class="card-text text-primary fw-bold mb-3">$${p.price}</p>
            <div class="mt-auto d-grid gap-2">
              <button class="btn btn-outline-primary" data-action="ver" data-id="${p.id}">
                <i class="fa fa-eye"></i> Ver detalle
              </button>
              ${canToggle ? `
                <button class="btn ${p.available ? "btn-outline-danger" : "btn-outline-success"}" data-action="toggle" data-id="${p.id}" data-available="${p.available?1:0}">
                  ${p.available ? '<i class="fa fa-ban"></i> Marcar Agotado' : '<i class="fa fa-check"></i> Marcar Disponible'}
                </button>` : ""}
            </div>
          </div>
        </div>
      </div>`;
  }

  async function fetchProducts(){
    const params = new URLSearchParams();
    if (state.q) params.set("q", state.q);
    if (state.category && state.category !== "all") params.set("category", state.category);
    // Staff ve todo: no filtrar por disponibilidad
    params.set("page", state.page);
    params.set("limit", 12);
    const url = API + "/api/productos?" + params.toString();
    const res = await fetch(url, { credentials: "include" });
    if (!res.ok) throw new Error("No se pudo cargar productos");
    return res.json(); // { items, total, page, pages }
  }

  async function load(){
    await whoamiAndGuard();
    const { items, page, pages } = await fetchProducts();
    grid.innerHTML = items.map(renderCard).join("");
    state.pages = pages;
    pageInfo.textContent = `Página ${page} de ${pages}`;
    prevBtn.disabled = page <= 1;
    nextBtn.disabled = page >= pages;
  }

  // Handlers UI
  searchInput?.addEventListener("input", (e) => {
    state.q = e.target.value.trim();
    state.page = 1;
    load().catch(console.error);
  });

  filterBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      filterBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      state.category = btn.dataset.category || "all";
      state.page = 1;
      load().catch(console.error);
    });
  });

  prevBtn.addEventListener("click", () => { if (state.page>1){ state.page--; load().catch(console.error);} });
  nextBtn.addEventListener("click", () => { if (state.page<state.pages){ state.page++; load().catch(console.error);} });

  // Delegación de eventos
  document.addEventListener("click", async (ev) => {
    const btn = ev.target.closest("button[data-action]");
    if (!btn) return;
    const id = Number(btn.dataset.id);
    const action = btn.dataset.action;

    if (action === "ver") {
      const res = await fetch(`${API}/api/productos/${id}`, { credentials: "include" });
      const p = await res.json();
      modalName.textContent = p.nombre;
      modalPrice.textContent = `$${p.price}`;
      modalImage.innerHTML = `<img src="${p.imagen}" class="img-fluid rounded">`;
      modalIngr.innerHTML = (p.ingredients || []).map(i => `<li>${i}</li>`).join("");
      modalStock.className = "alert " + (p.available ? "alert-success" : "alert-danger");
      modalStock.textContent = p.available ? "Disponible" : "Agotado";
      modal.show();
    }

    if (action === "toggle") {
      const current = btn.getAttribute("data-available") === "1";
      const res = await fetch(`${API}/api/productos/${id}/available`, {
        method: "PATCH",
        headers: { "Content-Type":"application/json" },
        credentials: "include",
        body: JSON.stringify({ available: current ? 0 : 1 })
      });
      if (!res.ok) { alert("Sin permiso o error"); return; }
      await load();
    }
  });

  document.addEventListener("DOMContentLoaded", () => load().catch(console.error));
})();
    </script>

</body>
</html>
